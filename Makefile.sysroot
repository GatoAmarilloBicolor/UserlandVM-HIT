# UserlandVM-HIT with Cosmoe Sysroot Makefile
# Integrates Haiku userland emulation with BeOS/Haiku API on Linux

CXX = g++
CXXFLAGS = -std=c++17 -no-pie -O2 -Wall -Wextra
INCLUDES = -I. -I./sysroot/include -I./sysroot/include/os
LDFLAGS = -L./sysroot/lib

# Enhanced VM with sysroot support
MASTER_VM = userlandvm_haiku32_master
ENHANCED_VM = userlandvm_haiku32_haiku_os  
COMPLETE_VM = userlandvm_haiku32_complete
PT_INTERP_VM = userlandvm_haiku32_enhanced_interp
ULTRA_OPT_VM = userlandvm_haiku32_ultra_optimized
SIMPLIFIED_VM = userlandvm_haiku32_simplified_pt_interp

# New sysroot-integrated versions
SYSROOT_MASTER = userlandvm_haiku32_sysroot_master
SYSROOT_ENHANCED = userlandvm_haiku32_sysroot_enhanced
SYSROOT_COSMOE = userlandvm_haiku32_cosmoe

# Source files
ENHANCED_SOURCES = userlandvm_haiku32_haiku_os.cpp
MASTER_SOURCES = userlandvm_haiku32_master.cpp
COMPLETE_SOURCES = userlandvm_haiku32_complete.cpp
PT_INTERP_SOURCES = userlandvm_haiku32_enhanced_interp.cpp
ULTRA_OPT_SOURCES = userlandvm_haiku32_ultra_optimized.cpp
SIMPLIFIED_SOURCES = userlandvm_haiku32_simplified_pt_interp.cpp

# Cosmoe-based VM
SYSROOT_SOURCES = userlandvm_haiku32_sysroot.cpp

# All source files
ALL_SOURCES = $(wildcard *.cpp)

# Default target
all: $(SYSROOT_COSMOE)

# Sysroot-integrated VM
$(SYSROOT_MASTER): $(SYSROOT_SOURCES)
	@echo "ðŸ—ï¸ Building Sysroot Master VM..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(LDFLAGS) -o $@ $(SYSROOT_SOURCES)
	@echo "âœ… Sysroot Master VM built: $@"

$(SYSROOT_ENHANCED): $(SYSROOT_SOURCES)
	@echo "ðŸ”¨ Building Enhanced Sysroot VM..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(LDFLAGS) -o $@ $(SYSROOT_SOURCES)
	@echo "âœ… Enhanced Sysroot VM built: $@"

$(SYSROOT_COSMOE): $(SYSROOT_SOURCES)
	@echo "ðŸŽ¯ Building Cosmoe-based VM with Sysroot..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(LDFLAGS) -o $@ $(SYSROOT_SOURCES)
	@echo "âœ… Cosmoe VM with Sysroot built: $@"

# Original VM versions
$(ENHANCED_VM): $(ENHANCED_SOURCES)
	@echo "ðŸ”¨ Building Enhanced UserlandVM-HIT..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $(ENHANCED_SOURCES)
	@echo "âœ… Enhanced VM built: $@"

$(ULTRA_OPT_VM): $(ULTRA_OPT_SOURCES)
	@echo "ðŸš€ Building Ultra-Optimized PT_INTERP..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $(ULTRA_OPT_SOURCES)
	@echo "âœ… Ultra-Optimized VM built: $@"

$(SIMPLIFIED_VM): $(SIMPLIFIED_SOURCES)
	@echo "ðŸ”¨ Building Simplified PT_INTERP..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $(SIMPLIFIED_SOURCES)
	@echo "âœ… Simplified PT_INTERP built: $@"

# Build all versions
all-versions: $(ENHANCED_VM) $(ULTRA_OPT_VM) $(SIMPLIFIED_VM) $(SYSROOT_COSMOE)
	@echo "ðŸŽ¯ All VM versions built with Cosmoe Sysroot integration"

# Sysroot-focused builds
sysroot-all: $(SYSROOT_MASTER) $(SYSROOT_ENHANCED) $(SYSROOT_COSMOE)
	@echo "ðŸŽ¯ All Sysroot VM versions built"

# Test programs using sysroot
test-sysroot: $(SYSROOT_COSMOE)
	@echo "ðŸ§ª Testing with Cosmoe Sysroot..."
	./$(SYSROOT_COSMOE) test_haiku_simple

# Setup and build Cosmoe
setup-cosmoe:
	@echo "ðŸ“¦ Setting up Cosmoe sysroot..."
	@if [ ! -d "cosmoe" ]; then \
		echo "Cloning Cosmoe..."; \
		git clone https://gitlab.com/haydentech/cosmoe.git; \
	fi
	@echo "ðŸ“š Setting up sysroot..."
	@if [ ! -d "sysroot" ]; then \
		mkdir -p sysroot/include sysroot/src; \
		cp -r cosmoe/headers/* sysroot/include/; \
		cp -r cosmoe/src/* sysroot/src/; \
		echo "# UserlandVM-HIT Cosmoe Sysroot Setup Complete" > sysroot/README.md; \
	fi
	@echo "âœ… Cosmoe sysroot ready!"

# Cosmoe library builds
build-cosmoe:
	@echo "ðŸ—ï¸ Building Cosmoe libraries..."
	cd cosmoe && meson setup build && ninja -C build
	@echo "âœ… Cosmoe libraries built"

# Create Haiku-style test program using Cosmoe
test-haiku-program: $(SYSROOT_COSMOE)
	@echo "ðŸ“ Creating Haiku test program with Cosmoe..."
	@echo 'CXX = g++' > test_cosmoe_haiku/Makefile
	@echo 'CXXFLAGS = -std=c++17 -I../../sysroot/include -I../../sysroot/include/os' >> test_cosmoe_haiku/Makefile
	@echo 'all: haiku_test_app' >> test_cosmoe_haiku/Makefile
	@echo '' >> test_cosmoe_haiku/Makefile
	@echo 'haiku_test_app: haiku_test_app.cpp' >> test_cosmoe_haiku/Makefile
	@echo '	$$(CXX) $$(CXXFLAGS) -o $$@ $$<' >> test_cosmoe_haiku/Makefile
	@echo '	@echo "âœ… Haiku test app built with Cosmoe"' >> test_cosmoe_haiku/Makefile
	@mkdir -p test_cosmoe_haiku
	@echo '#include <Be.h>' > test_cosmoe_haiku/haiku_test_app.cpp
	@echo '#include <stdio.h>' >> test_cosmoe_haiku/haiku_test_app.cpp
	@echo '' >> test_cosmoe_haiku/haiku_test_app.cpp
	@echo 'int main() {' >> test_cosmoe_haiku/haiku_test_app.cpp
	@echo '    printf("Hello from Haiku app using Cosmoe on Linux!\\n");' >> test_cosmoe_haiku/haiku_test_app.cpp
	@echo '    return 0;' >> test_cosmoe_haiku/haiku_test_app.cpp
	@echo '}' >> test_cosmoe_haiku/haiku_test_app.cpp
	cd test_cosmoe_haiku && make

# Test with Cosmoe Haiku app
test-cosmoe-app: test-haiku-program
	@echo "ðŸ§ª Testing Cosmoe Haiku application..."
	./test_cosmoe_haiku/haiku_test_app

# Clean targets
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -f $(MASTER_VM) $(ENHANCED_VM) $(COMPLETE_VM) $(PT_INTERP_VM)
	rm -f $(ULTRA_OPT_VM) $(SIMPLIFIED_VM) $(SYSROOT_MASTER) $(SYSROOT_ENHANCED) $(SYSROOT_COSMOE)
	rm -f *.o
	rm -rf test_cosmoe_haiku
	@echo "âœ… Clean completed"

deep-clean: clean
	@echo "ðŸ§¹ Deep clean..."
	rm -rf sysroot cosmoe
	@echo "âœ… Deep clean completed"

# Documentation
docs:
	@echo "ðŸ“š Generating documentation..."
	@echo "# UserlandVM-HIT with Cosmoe Sysroot" > README_SYSROOT.md
	@echo "" >> README_SYSROOT.md
	@echo "## Build Commands" >> README_SYSROOT.md
	@echo "" >> README_SYSROOT.md
	@echo "### Sysroot Builds:" >> README_SYSROOT.md
	@echo "make sysroot-all       # Build all sysroot versions" >> README_SYSROOT.md
	@echo "make \$$\(SYSROOT_COSMOE\)  # Build main Cosmoe VM" >> README_SYSROOT.md
	@echo "" >> README_SYSROOT.md
	@echo "### Setup:" >> README_SYSROOT.md
	@echo "make setup-cosmoe     # Clone and setup Cosmoe" >> README_SYSROOT.md
	@echo "make build-cosmoe     # Build Cosmoe libraries" >> README_SYSROOT.md
	@echo "" >> README_SYSROOT.md
	@echo "### Testing:" >> README_SYSROOT.md
	@echo "make test-sysroot      # Test VM with sysroot" >> README_SYSROOT.md
	@echo "make test-cosmoe-app # Test Cosmoe Haiku app" >> README_SYSROOT.md
	@echo "âœ… Documentation generated: README_SYSROOT.md"

# Help target
help:
	@echo "UserlandVM-HIT with Cosmoe Sysroot"
	@echo "===================================="
	@echo ""
	@echo "Build Targets:"
	@echo "  make                    # Build main Cosmoe VM"
	@echo "  make sysroot-all       # Build all sysroot versions"
	@echo "  make \$$\(SYSROOT_COSMOE\)  # Build main Cosmoe VM"
	@echo "  make all-versions      # Build all VM versions"
	@echo ""
	@echo "Setup Targets:"
	@echo "  make setup-cosmoe     # Clone and setup Cosmoe"
	@echo "  make build-cosmoe     # Build Cosmoe libraries"
	@echo ""
	@echo "Test Targets:"
	@echo "  make test-sysroot      # Test VM with sysroot"
	@echo "  make test-cosmoe-app # Test Cosmoe Haiku app"
	@echo ""
	@echo "Utility Targets:"
	@echo "  make docs              # Generate documentation"
	@echo "  make clean             # Clean build artifacts"
	@echo "  make deep-clean        # Deep clean including sysroot"
	@echo "  make help              # Show this help"

# Phony targets
.PHONY: all sysroot-all setup-cosmoe build-cosmoe test-haiku-program test-sysroot test-cosmoe-app docs clean deep-clean help

# Default goal
.DEFAULT_GOAL := all